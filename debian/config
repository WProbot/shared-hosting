#!/bin/sh

# Exit on any errors
set -e

# Load the `debconf` library functions
. /usr/share/debconf/confmodule

# Exit gracefully if `letsencrypt` or `mysql` are missing
hash letsencrypt 2>/dev/null || exit 0
hash mysql       2>/dev/null || exit 0

# Declare the notice informing the user that they can skip a question
SKIP_PHRASE="Press enter to keep the current value."

# Ensure that the configuration file exists
mkdir -p /etc/shared-hosting
# Prevent non-root users from accessing the package configuration
chmod o= /etc/shared-hosting

EMAIL=""
MY_PWD=""
WEB_GROUP=""
# Attempt to load the current config values
if [ -f "/etc/shared-hosting/config.json" ]; then
  EMAIL="$(jq -Mr .email /etc/shared-hosting/config.json 2> /dev/null)"
  MY_PWD="$(jq -Mr .password /etc/shared-hosting/config.json 2> /dev/null)"
  WEB_GROUP="$(jq -Mr .group /etc/shared-hosting/config.json 2> /dev/null)"
  # Override the values currently held by debconf
  db_set shared-hosting/email          "$EMAIL"
  db_set shared-hosting/mysql-password "$MY_PWD"
  db_set shared-hosting/force-group    "$WEB_GROUP"
  # Print the current configuration values
  echo "Found current configuration values:"
  echo    "  * E-mail Address: $EMAIL"
  echo -n "  * MySQL Password: "
  if [ -n "$MY_PWD" ]; then echo "********"; else echo ""; fi
  echo    "  * Group Override: $WEB_GROUP"
else
  # Create the configuration file if it does not exist
  echo "Creating new configuration file ..."
  touch /etc/shared-hosting/config.json
fi

while [ "$1" = "reconfigure" ] || [ -z "$EMAIL" ]; do
  if [ "$1" = "reconfigure" ]; then
    db_subst shared-hosting/email skippable "$SKIP_PHRASE"
  fi
  db_input high shared-hosting/email || true
  db_go
  db_get shared-hosting/email
  # Skip the verification process if no changes were made
  if [ -n "$EMAIL" ] && [ "$RET" = "$EMAIL" ]; then break; fi
  # Only attempt registration if it makes sense
  if [ -n "$RET" ]; then
    # Attempt to register using the provided value
    letsencrypt register --quiet --non-interactive \
      --agree-tos -m "$RET" && break
  fi; sleep 1
done

while [ "$1" = "reconfigure" ] || [ -z "$MY_PWD" ]; do
  if [ "$1" = "reconfigure" ]; then
    db_subst shared-hosting/email skippable "$SKIP_PHRASE"
  fi
  db_input high shared-hosting/mysql-password || true
  db_go
  db_get shared-hosting/mysql-password
  # Skip the verification process of no changes were made
  if [ -n "$MY_PWD" ] && [ "$RET" = "$MY_PWD" ]; then break; fi
  # Only attempt login if it makes sense
  if [ -n "$RET" ]; then
    mysql -u root -p"$RET" -e 'QUIT' 2> /dev/null && break
  fi; sleep 1
done

while [ "$1" = "reconfigure" ] || [ -z "$WEB_GROUP" ]; do
  if [ "$1" = "reconfigure" ]; then
    db_subst shared-hosting/email skippable "$SKIP_PHRASE"
  fi
  db_input high shared-hosting/force-group || true
  db_go
  db_get shared-hosting/force-group
  # Skip the verification process of no changes were made
  if [ -n "$WEB_GROUP" ] && [ "$RET" = "$WEB_GROUP" ]; then break; fi
  # Only attempt to fetch the group if it makes sense
  if [ -n "$RET" ]; then
    getent group "$RET" 2>&1 > /dev/null && break
  fi; sleep 1
done
