#!/bin/sh

# Exit on any errors
set -e

# Load the `debconf` library functions
. /usr/share/debconf/confmodule

# Ensure that the configuration file exists
mkdir -p /etc/shared-hosting
# Prevent non-root users from accessing the package configuration
chmod o= /etc/shared-hosting

# Create the configuration file if it does not exist
if [ ! -f "/etc/shared-hosting/config.json" ]; then
  touch /etc/shared-hosting/config.json
fi

# Attempt to configure the database using dbconfig-common
if [ -f /usr/share/dbconfig-common/dpkg/config.mysql ]; then
  . /usr/share/dbconfig-common/dpkg/config.mysql
  dbc_dbname="hosting_schema"
  dbc_dbtypes="mysql"
  dbc_go shared-hosting "$@"
fi

# Ask the user whether they want group overrides
db_input high shared-hosting/force-group || true
db_go
db_get shared-hosting/force-group
# Attempt to verify the provided group
if [ -n "$RET" ] && [ "$RET" != "$WEB_GROUP" ]; then
  getent group "$RET" 2>&1 > /dev/null
fi
